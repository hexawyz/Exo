# NZXT Kraken Z63

This device is a composite device that has both a "vendor-specific" endpoint accessed by CAM through WinUsb for some reason, and a more regular "HID" endpoint, also relying on a fully custom protocol.
The reasons behind this are unclear yet, and naive observations only show data exchanged over the HID endpoint.

By trying to change the images in CAM, we can see that the other (WinUSB) device interface is used to transmit some data packets, including entire gif images, or what seems to be raw RGBA data.
As such, the reason for the choice of a separate interface might have been tor that exact reason, as the image data can be quite long and of variable size.

## Quick analysis using Wireshark

HID protocol is always 64 bytes long, including the report descriptor.
However, as is relatively unusual, commands are split in their own reports, meaning that the report ID byte is not "wasted".

It seems that commands go by pair, with input reports having the bit 0 set, and output/feature reports having the bit 0 unset.
This can be observed by the 74 / 75 (request/response) pair used by NZXT CAM. However, it does not seem to always be the case.

### Format of responses

There seem to be two kinds of commands: Commands that have a dedicated response, and commands who don't.

In both cases, the format is similar:

````
<CommandId> <SubId> 1a 00 41 00 0a "Q840512" <Result> <Zero Padding>
````

Commands with a dedicated response seem to return a result, while other seem to just return some kind of `ACK`.
However, most commands with a dedicated response simply return the value `01`, which I'm assuming indicates success.

In the case of a dedicated response, the command id for the response is `CommandId OR 0x01`, and the result data depends on the command.

In the case of a generic ack response, the command id is always `FF`, and the sub-id is always `01` (?). The result data in that case contain two bytes identifying the original command id and sub-id.

NB: Meaning of other fields in the response is unclear/unknown.

### Status

````
REQ: 74 01 00 …
RES: 75 01 1a 00 41 00 0a 51383430353132 01 1f 09 ff 06 23 23 01 00 af 03 19 19 00 00 …
````

This seems to contain information about the device, periodically requested by CAM.
It contains the string "Q840512" that we also observe in `FF` messages.
Other values are changing, and among them we can see `ff 06` and `af 03`, which I'm pretty certain are the pump speed and the fan speed.
The numbers here, and across various occurrences, are similar in value to the ones displayed in NZXT CAM. (To be interpreted in little endian, i.e. `06ff` and `03af`)

The values `23 23` and `19 19` also vary in messages, always in pairs. => See below, duplication unexplained, but requested pump and fan speed %.

The value `1f` above would likely be the liquid temperature in °C, as it varies between 31 and 32°, which matches the observed messages.

The value `09` is yet unknown.

### Set pump/fan speed

We see the values `23` and `19` in the following requests:

````
72 02 01 01 19191919191919191919191919191919191919191919191919191919191919191919191919191919 0000000000000000000000000000000000000000
72 01 01 00 23232323232323232323232323232323232323232323232323232323232323232323232323232323 0000000000000000000000000000000000000000
````

The responses `FF` seem to be generated as a result of the `72` requests:

````
ff 01 1a 00 41 00 0a 51383430353132 72 02 000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
ff 01 1a 00 41 00 0a 51383430353132 72 01 000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
````

The response also contains the "Q840512" string (which might be some kind of model ID?)
Interestingly, we can see the request id `72` and what would be the subcommand id (`01` or `02` here) appearing here, probably acknowledging the request.

It is possible that the values sent here are the requested power of pump and fan in %.

… and indeed, these are the commands that are sent when the "fixed" mode is enabled (Fixed mode is Pump at 100% and fan at 40%)

````
72 01 01 00 646464646464646464646464646464646464646464646464646464646464646464646464646464640000000000000000000000000000000000000000
72 02 01 01 282828282828282828282828282828282828282828282828282828282828282828282828282828280000000000000000000000000000000000000000
````

As such, we can deduce that `01` is pump and `02` is fan. Following value unknown, and third value is `00` for pump and `01` for fan. (Meaning unknown yet)

### Set screen brightness (`30 02`)

Minimum value:

````
REQ: 30 02 01 00 00 00 00 03 0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
RES: ff 01 1a 00 41000a 51383430353132 30 02 000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
````

Maximum value:

````
REQ: 30 02 01 64 00 00 00 03 0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
RES: ff 01 1a 00 41000a 51383430353132 30 02 000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
````

This seems pretty straightforward. Brightness goes from 0 to 100.

NB: I observed another example of the `30 02` command when trying to rotate the screen:

````
REQ: 30 02 00 00 00 00 01 03 0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
````

I only saw that one once, so I'm unsure what it could be, but I wonder if it indicates some kind of native rotation support.
However, the images seem to be software rotated, so I'm unsure about that.

### Change image (`38 01`)

This command will change the image displayed on the device.

````
REQ: 38 01 04 0d 000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
RES: 39 01 1a 00 41000a 51383430353132 01 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
````

The command seems to take two parameters, the first one being always 4, and the second one being the stored image ID, from 0 to 15.
I suspect that the first parameter might be another sub-id.

### ??? Before and after a change of image to GIF

#### Before

On the HID interface:

````
REQ: 36 01 08 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
RES: 37 01 1a 0041000a 51383430353132 01 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
````

#### Image Upload

On the raw USB interface:

````
OUT: 12fa01e8abcdef9876543210010000008f820000
OUT: 47494638396140014001f6000000000000132d001c3d001e4100264fe8e9ed002954002c5a002d5bcccbd0002f5f003366b1b3bdaaadb79999998e8d908a8a8b …
````

The first output might be some kind of "header" command to prepare the upload of the image.

#### After

On the HID interface:

````
REQ: 36 02 0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
RES: 37 02 1a0041000a 51383430353132 01 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
````


### ??? Before and after a raw image frame

#### Before

On the HID interface:

````
REQ: 32 02 06 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
RES: 33 02 1a0041000a 51383430353132 01 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
REQ: 32 02 06 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
RES: 33 02 1a0041000a 51383430353132 01 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
REQ: 32 01 06 07c012900101 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
RES: 33 01 1a0041000a 51383430353132 01 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
REQ: 36 01 06 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
RES: 37 01 1a0041000a 51383430353132 01 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
````

#### Image Upload

On the raw USB interface:

````
OUT: 12fa01e8abcdef98765432100200000000400600
OUT: 000000ff 000000ff 000000ff 000000ff 000000ff …
````

The first command is slightly different from the one used for GIF, and it might indicate the format (that, or it is indicated in the previous commands)
The image data seems to represent a 320x320 surface in RGBA format, for a total of 409600 bytes. (Sent in a single packet)

(NB: 409600 is `64000` in hex; 102400 is `19000`.)

#### After

On the HID interface:

````
REQ: 36 02 0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
RES: 37 02 1a0041000a 51383430353132 01 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
REQ: 38 01 04 06 000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
RES: 39 01 1a0041000a 51383430353132 01 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
````

NB: After verifying other iterations, it seems the `06` in the commands `36 01` and `38` is correlated with the `06` in the command `32`. (i.e. it changes in other sequences)

### Samples of the `32` request

#### `32 01`

From Capture 1:

````
32 01 03 04 800c 9001 01 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
32 01 04 05 100e 9001 01 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
32 01 05 06 a00f 9001 01 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
32 01 0b 0c 3011 9001 01 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
32 01 06 07 c012 9001 01 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
32 01 07 08 0000 9001 01 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
````

From Capture 2:

````
32 01 05 06 310e 9001 01 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
32 01 0b 0c c10f 9001 01 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
32 01 06 07 5111 9001 01 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
32 01 07 08 0000 9001 01 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
32 01 09 0a 9001 9001 01 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
32 01 0a 0b 2003 9001 01 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
32 01 0c 0d b004 9001 01 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
32 01 08 09 7017 9001 01 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
32 01 0e 0f 4006 9001 01 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
32 01 00 01 f107 9001 01 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
32 01 0d 0e e112 9001 01 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
32 01 01 02 7114 9001 01 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
32 01 0f 10 0019 9001 01 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
32 01 02 03 8109 9001 01 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
32 01 03 04 110b 9001 01 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
32 01 04 05 a10c 9001 01 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
32 01 05 06 310e 9001 01 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
32 01 0b 0c c10f 9001 01 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
32 01 06 07 5111 9001 01 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
32 01 07 08 0000 9001 01 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
32 01 09 0a 9001 9001 01 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
32 01 0a 0b 2003 9001 01 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
32 01 0c 0d b004 9001 01 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
32 01 08 09 0116 9001 01 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
32 01 0e 0f 4006 9001 01 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
32 01 00 01 d007 9001 01 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
32 01 0d 0e e112 9001 01 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
32 01 01 02 7114 9001 01 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
32 01 0f 10 9117 9001 01 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
32 01 02 03 6009 9001 01 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
32 01 03 04 f00a 9001 01 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
32 01 04 05 800c 9001 01 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
32 01 05 06 100e 9001 01 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
32 01 0b 0c a00f 9001 01 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
32 01 06 07 3011 9001 01 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
32 01 07 08 0000 9001 01 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
32 01 09 0a 9001 9001 01 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
32 01 0a 0b 2003 9001 01 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
32 01 0c 0d b004 9001 01 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
32 01 08 09 0116 9001 01 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
32 01 0e 0f 4006 9001 01 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
32 01 00 01 d007 9001 01 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
32 01 0d 0e c012 9001 01 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
32 01 01 02 5014 9001 01 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
32 01 0f 10 9117 9001 01 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
32 01 02 03 6009 9001 01 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
32 01 03 04 f00a 9001 01 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
32 01 04 05 800c 9001 01 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
````

From Changing GIF images Capture:

````
32 01 08 09 e015 9001 01 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 (RAW)
32 01 0e 0f 4006 9001 01 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 (RAW)
32 01 00 01 d007 9001 01 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 (RAW)
32 01 0d 0e 5111 5302 01 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 (GIF)
32 01 01 02 2119 6c0d 01 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 (GIF)
32 01 0f 10 8d26 e506 01 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 (GIF)
32 01 02 03 722d b504 01 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 (GIF)
32 01 03 04 2732 e603 01 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 (GIF)
````

By analyzing the above data, we can identify that the second parameter is always the value of the first parameter + 1.
First parameter is a value from `00` to `0f` , and second parameter is (as such) a value from `01` to `10`.

We can also identify the repeated value of `9001` which is 400 in little endian, as the N-1 (fourth?) parameter.
While it is constant (400) for raw images, it is, however, not, for GIF images. Could it be some kind of timing?

The last parameter seems to always be `01`.

For raw images, the third parameter seems to be a value that is often incremented by 400 in the following batch (400 is the value of the next parameter: might be related)
At the beginning of capture 2, the value is an odd number (3633), but it resets to `0000` relatively quickly. However, there are still some "irregular" values in the sequence.

The values of parameters 1&2 do not seem to be correlated with the value of parameter 3:
While the same values are reused over different commands, we can see different pairs of values.

#### `32 02`

32 02 03 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
32 02 04 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
32 02 05 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
32 02 0b 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
32 02 06 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
32 02 07 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000

As seen before, the value here is reused in other commands. Parameter is a byte from `00` to `0f`.

### Samples of the `38` request

#### `38 01`

````
38 01 04 05 000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
38 01 04 0b 000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
38 01 04 06 000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
38 01 04 07 000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
38 01 04 09 000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
38 01 04 0a 000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
38 01 04 0c 000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
38 01 04 08 000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
38 01 04 0e 000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
````

Not very useful as-is. The first parameter is always `04`, and the second parameter is the same as passed to other commands.

### Changing between GIF images

From NZXT CAM, we can change between multiple "recent" GIF images easily, which gave some interesting results.

It seems that GIF images are uploaded upon first change, which can take a long time. And very big images even seem to be cut into multiple raw packets. (so there is a limit ?)

But then, switching back to a previous image is almost instantaneous, which indicates that the device can remember multiple images.

The parameter used in the commands `32`, `36` and `38` is likely the image index.

### Samples of the pre-transfer packet on the raw USB interface

From changing GIF images capture:

````
12fa01e8 abcdef9876543210 02 000000 00400600 (RAW; Followed by 409600 bytes transfer)
12fa01e8 abcdef9876543210 01 000000 7d490900 (GIF; Followed by 608637 bytes transfer)
12fa01e8 abcdef9876543210 01 000000 0ead3500 (GIF; Followed by 2097152 bytes transfer; Followed by 1420558 bytes transfer; Total of 3517710 bytes transfer.)
12fa01e8 abcdef9876543210 01 000000 74931b00 (GIF; Followed by 1807220 bytes transfer)
12fa01e8 abcdef9876543210 01 000000 93d11200 (GIF; Followed by 1233299 bytes transfer)
12fa01e8 abcdef9876543210 01 000000 d7950f00 (GIF; Followed by 1021399 bytes transfer)
````

From the above examples (a single one of them is enough, though), we can deduce that the transfer length is encoded in the last 4 bytes, in little endian form.

Some other parameters are less clear, but we can at least identify the parameter indicating the image format, with `01` for GIF and `02` for RGBA. (Are there other supported formats ?)

The `abcdef9876543210` sequence seems oddly specific, so it is probably some kind of signature designated to tag these messages, e.g. in case of an interrupted transmission.

The other values, however… No idea. They at least don't seem correlated with the image index.


