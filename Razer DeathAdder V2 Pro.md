This device and the compatible dock can work without any driver, but if we want to configure it and play with the RGB features, we need to analyze the protocol.
I sacrificed my computer for science and installed the terrible software that Synapse 3 is, and the experience was less than pleasing.

One interesting thing is that as soon as the installer started, some requests were emitted on the two devices, likely to get information, using feature reports.

SET => 000800000002008600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008400            
GET => 020800000002008600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008400                    

SET => 000800000002008600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008400            
GET => 020800000002008600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008400                    

After that, when starting the actual installation, the bloated software sent a huge lot of requests, while taking several minutes to do what should have been nothing…
And messed up with ALL USB devices on the system. ALL of them. Competitor's mouse, Stream Deck, etc. TWO TIMES. My other mouse stopped working for tens of seconds while this was happening.
It seems it was doing some nasty stuff to the windows USB stack. At least something like restarting it, but maybe it installed some kind of filter driver on the system.
Indeed I see two drivers files, "RzDev_007c.sys" and "RzDev_007e.sys" associated with the mouse (USB dongle) and Dock. I'm unsure they were here prior to this.
Worthy of note, is that this crappy software asked me to restart the system after the installation, as was also notified by the windows driver install popups.
It did still seem to somehow work without doing that.
Let's hope these drivers are not a vital part of anything.

Upon starting razer synapse, it started emitting a lot of requests to the device. This was presumably to manually orchestrate the color cycling effect, which is also an hardware effect -_-
From testing around with Wireshark still opened, it would seem as if all effects are implemented in software using regular frequency manual color updates. Even fading out to black, etc.

# Analyzing the protocol

As often, Wireshark is operating a bit weird here. It seems unable to interpret the data part of GET feature responses while present in the packet.

When starting Synapse 3:

SET => 001f00000002008400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008600
GET => 021f00000002008400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008600

SET => 001f00000002000403000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000500
GET => 021f00000002000403000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000500

First of all the n-1 byte of a packet (89th byte out of 90) seems to be a checksum of sorts. (We see that value constantly changing, and it is well isolated)
Judging by the requests/responses above, this is definitely a XOR checksum of all the bytes except for the fist two and last two.

BTW we can see the installer using various report IDs to communicate with the devices, but they are probably not the ones we are interested in for now. (We cans till dig in the captures later)
The report shown above (report ID 0 of 90 bytes) is the one we are interested in and is likely the standard razer protocol for these devices.

Hopefully, the razer protocol is relatively universal across devices. (Which I seem was the rational for devices supported in Synapse 3 vs those only supported by Synapse 2)
If that's the case, what we find here can be reused more widely 🤞

This is a request that seemingly sets the RGB color on the dock:

SET => 001f000000080f030000000000ff5f04000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000

Since these are (always?) sent using feature reports, they don't expect any response other than an ack from the device.

We can see what seems to be the color above: ff5f04. This was chosen semi randomly from a long sequence of similar requests.
The color values that are sent to the device seem somewhat strange, as they are not the aggressive FF0000 => FFC000 => FF8000 etc. sequences that we would usually see.

It seems that all requests start with 001f. (And all responses start with 021f ?)

Let's ignore the checksum byte and trim the requests to compare various requests sent to the device


001f 000000 02 00 84  # ?
001f 000000 02 00 04 03 # ?
001f 000000 02 00 86  # ?
001f 000000 08 0f 03  # ?
001f 000000 06 0f 02 00 00 08 00 01 # ?
001f 000000 08 0f 03 0000000000 ff5f04 # Set color
001f 000000 08 0f 03 0000000000 ff5e04 # Set color
001f 000000 08 0f 03 0000000000 ff6004 # Set color
001f 000000 08 0f 03 0000000000 00ff00 # Set color (To green, done in the UI)
001f 000000 03 0f 04 01 00 54 # Set brightness
001f 000000 03 0f 04 01 00 ed # Set brightness

The excerpts below are the parts where I tried to adjust the effect brightness:

001f000000030f04010049
001f000000030f04010082
001f000000030f040100ad
001f000000030f040100ba
001f000000030f04010038
001f000000080f03000000000000ff00 // Green (Static Color defined in the UI)
001f000000030f0401003d
001f000000030f04010047
001f000000030f04010051
001f000000030f04010051
001f000000030f04010054
001f000000030f040100ff

001f000000030f040100ed
001f000000030f040100c9
001f000000080f03000000000000ff00 // Green (Static Color defined in the UI)
001f000000030f040100af
001f000000030f04010091
001f000000030f04010084
001f000000030f04010059
001f000000030f0401003d
001f000000030f04010035
001f000000030f0401003d
001f000000030f04010044
001f000000080f03000000000000ff00 // Green (Static Color defined in the UI)
001f000000030f0401004c
001f000000030f0401004f
001f000000030f0401004f
001f000000030f04010054 // Brightness to 33 ?

Default brightness was "33" in the UI, so we would be looking for 0x21 or 0x55 if the values are based on 255 (which they seemed to be)…
Turns out the last command ends with the value 0x54 (after a manual reset to the value "33", which is a too close match to be a coincidence)

It seems that Razer software is sending/receiving all reports to/from endpoint 0 with report ID 0… And I can't make sense of that. (No HID descriptor seem to match and I believe I tried all device names just in case)
Might be a problem with USBpcap or Razer doesn't exactly respect the USB stack, which would explains why they have a proprietary (filter?) driver for each of their devices.
So, bad news probably. Unless I'm able to find the IO control codes to communicate with their drivers, it seems complicated for now.

To extract a large number of requests from a capture: (Sadly doesn't work for the GET FEATURE reports of these devices 🙁)
`tshark' -r "INPUT.pcapng" -T fields -e usb.irp_info.direction -e usb.data_fragment "usb.data_len >= 90 and usb.device_address == 48" > OUTPUT.txt`

## Requests sent to devices when the service is starting

### Dock

SET => 00 08 000000 020086 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008400
GET => 02 08 000000 020086 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008400

Still wondering about the above command, as it seems to return no information. (Handshake of some sorts ?)

SET => 00 08 000000 160082 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000009400
GET => 02 08 000000 160082 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx 0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000de00
                                                       SN

The above command does return the device Serial Number in ASCII form (as written on the sticker)

SET => 00 1f 000000 040087 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008300
GET => 02 1f 000000 040087 02 00 01 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000

The above command seems to return some information. Maybe the firmware version ? (Need to check in Synapse UI)

### Mouse (Dongle)

SET => 00 08 000000 020086 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008400
GET => 02 08 000000 020086 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008400

SET => 00 08 000000 160082 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000009400
GET => 02 08 000000 160082 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx 0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000cc00

SET => 00 08 000000 3100bf 02 000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008c00
GET => 02 08 000000 3100bf 02 01 00 7d 00 ff ff 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000f000

SET => 00 1f 000000 020086 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008400
GET => 02 1f 000000 020086 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008400

SET => 00 1f 000000 020086 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008400
GET => 01 1f 000000 020086 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008400
GET => 02 1f 000000 020086 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008400

SET => 00 1f 000000 040087 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008300
GET => 01 1f 000000 040087 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008300
GET => 02 1f 000000 040087 020201 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008200

SET => 00 1f 000000 040087 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008300
GET => 01 1f 000000 040087 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008300
GET => 02 1f 000000 040087 020201 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008200

SET => 00 1f 000000 020086 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008400
GET => 02 1f 000000 020086 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008400

SET => 00 1f 000000 040087 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008300
GET => 02 1f 000000 040087 020201 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008200

Why does this very same command sometimes return 2 values and sometimes only one ? Definitely looks something firmware-related, though.

SET => 00 08 000000 020086 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008400
GET => 02 08 000000 020086 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008400

SET => 00 1f 000000 020086 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008400
GET => 01 1f 000000 020086 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008400
GET => 02 1f 000000 020086 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008400

SET => 00 1f 000000 020086 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008400
GET => 01 1f 000000 020086 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008400
GET => 02 1f 000000 020086 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008400

SET => 00 1f 000000 040087 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008300
GET => 01 1f 000000 040087 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008300
GET => 02 1f 000000 040087 020201 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008200

SET => 00 1f 000000 020086 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008400
GET => 01 1f 000000 020086 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008400
GET => 02 1f 000000 020086 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008400

SET => 00 1f 000000 040087 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008300
GET => 01 1f 000000 040087 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008300
GET => 02 1f 000000 040087 020201 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008200

SET => 00 1f 000000 020086 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008400
GET => 01 1f 000000 020086 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008400
GET => 02 1f 000000 020086 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008400

SET => 00 1f 000000 040087 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008300
GET => 01 1f 000000 040087 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008300
GET => 02 1f 000000 040087 020201 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008200

SET => 00 1f 000000 020086 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008400
GET => 01 1f 000000 020086 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008400
GET => 02 1f 000000 020086 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008400

SET => 00 1f 000000 040087 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008300
GET => 02 1f 000000 040087 020201 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008200

SET => 00 1f 000000 020086 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008400
GET => 01 1f 000000 020086 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008400
GET => 02 1f 000000 020086 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008400

SET => 00 1f 000000 040087 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008300
GET => 01 1f 000000 040087 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008300
GET => 02 1f 000000 040087 020201 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008200

SET => 00 1f 000000 020086 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008400
GET => 02 1f 000000 020086 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008400

SET => 00 1f 000000 040087 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008300
GET => 02 1f 000000 040087 020201 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008200

SET => 00 1f 000000 020086 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008400
GET => 02 1f 000000 020086 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008400

SET => 00 1f 000000 040087 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008300
GET => 01 1f 000000 040087 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008300
GET => 02 1f 000000 040087 020201 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008200

SET => 00 1f 000000 020086 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008400
GET => 01 1f 000000 020086 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008400
GET => 02 1f 000000 020086 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008400

SET => 00 1f 000000 040087 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008300
GET => 01 1f 000000 040087 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008300
GET => 02 1f 000000 040087 020201 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008200

SET => 00 1f 000000 020086 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008400
GET => 01 1f 000000 020086 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008400
GET => 02 1f 000000 020086 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008400

SET => 00 1f 000000 01058a 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008e00
GET => 02 1f 000000 01058a 05 000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008b00

SET => 00 1f 000000 010580 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008400
GET => 02 1f 000000 010580 01 000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008500

SET => 00 1f 000000 410581 0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c500
GET => 02 1f 000000 020581 05 01 0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008200

SET => 00 1f 000000 020680 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008400
GET => 02 1f 000000 020680 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008400

SET => 00 1f 000000 0e068e 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008600
GET => 02 1f 000000 0e068e 00 64 00 05e0 00 00 05e0 0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e200

The `64` in the command above might be the battery level ? (I don't remember the exact charge level at this moment, but this could be 100% ?)
We also see 05e0 repeated two times, but the particular meaning of that is unclear.

SET => 00 1f 000000 020086 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008400
GET => 01 1f 000000 020086 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008400
GET => 02 1f 000000 020086 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008400

SET => 00 1f 000000 01058a 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008e00
GET => 02 1f 000000 01058a 05 000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008b00

SET => 00 1f 000000 010580 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008400
GET => 02 1f 000000 010580 01 000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008500

SET => 00 1f 000000 410581 0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c500
GET => 02 1f 000000 020581 0501 0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008200

SET => 00 1f 000000 020680 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008400
GET => 02 1f 000000 020680 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008400

SET => 00 1f 000000 020086 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008400
GET => 01 1f 000000 020086 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008400
GET => 02 1f 000000 020086 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008400

SET => 00 1f 000000 040087 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008300
GET => 02 1f 000000 040087 020201 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008200

SET => 00 1f 000000 020086 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008400
GET => 01 1f 000000 020086 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008400
GET => 02 1f 000000 020086 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008400

SET => 00 1f 000000 040087 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008300
GET => 01 1f 000000 040087 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008300
GET => 02 1f 000000 040087 020201 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008200

SET => 00 1f 000000 020086 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008400
GET => 01 1f 000000 020086 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008400
GET => 02 1f 000000 020086 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008400

SET => 00 1f 000000 040087 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008300
GET => 02 1f 000000 040087 020201 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008200

SET => 00 1f 000000 020086 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008400
GET => 01 1f 000000 020086 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008400
GET => 02 1f 000000 020086 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008400

SET => 00 1f 000000 040087 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008300
GET => 01 1f 000000 040087 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008300
GET => 02 1f 000000 040087 020201 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008200

SET => 00 1f 000000 020086 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008400
GET => 01 1f 000000 020086 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008400
GET => 02 1f 000000 020086 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008400

SET => 00 1f 000000 040087 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008300
GET => 02 1f 000000 040087 020201 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008200

SET => 00 1f 000000 020086 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008400
GET => 01 1f 000000 020086 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008400
GET => 02 1f 000000 020086 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008400

SET => 00 1f 000000 040087 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008300
GET => 02 1f 000000 040087 020201 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008200

# Standard Lighting API ??

By manually analyzing the numerous HID reports returned by the mouse, it would seem that it implements the standard HID lighting controls on device interfaces 3 and 4…
This could be a viable alternative to the Razer custom protocol.
However, there are two things regarding this:

 * If it works (would need to be verified), we need to implement a generic way to handle standard Lighting & Illumination collections, and probably deal with the Windows flavor of parsed HID descriptors.
 * We likely still want to have the Razer protocol working because it would allow editing mouse profiles & getting battery info.
 * These two interfaces would be the ones that constantly error out when scanning the devices using DeviceTools.Cli. This predates the installation of Synapse 3. 
 
Maybe Windows is reserving these collections for itself with their upcoming RGB lighting feature ?
=> Seems to be the case. As explained here, the new API allows automatic control of all HID devices compliant with the new HID Lighting & Illumination page: https://learn.microsoft.com/en-us/windows/uwp/devices-sensors/lighting-dynamic-lamparray
While not said explicitly in the docs, it seems that going through the API will be mandatory to access these devices, so no raw access.
This is kind of a good thing, as we could be able to rely on this (and will need to do so for some future devices), and it avoids the necessity for parsing HID reports.
However, the documentation implies that lighting control would only be available in **applications**, which would be a problem.
It also says that **applications** need to register as a lighting controller in order to control lights in the background, which we'll need to do.
If possible I'd like to avoid relying on WinRT APIs and find lower level APIs such as DevQuery* C APIs to control these features.
I'll try digging in the Windows SDK headers and see if I find anything of use. In the meantime, let's wait for the official feature to roll out.
(To be fair I'm half happy and half sad about it. It should be a good thing in general, but will make a lot of the work here redundant 🙁)

Interface 3:

HID Report
    Usage Page (Lighting and Illumination)
    Usage (LampArray)
    Collection (Application)
        Header
        Collection type: Application (0x01)
        Report ID (0x01)
        Usage (LampArrayAttributesReport)
        Collection (Logical)
            Header
            Collection type: Logical (0x02)
            Usage (LampCount)
            Logical Minimum (0)
            Logical Maximum (65535)
            Report Size (16)
            Report Count (1)
            Feature (Const,Var,Abs)
            Usage (BoundingBoxWidthInMicrometers)
            Usage (BoundingBoxHeightInMicrometers)
            Usage (BoundingBoxDepthInMicrometers)
            Usage (LampArrayKind)
            Usage (MinUpdateIntervalInMicroseconds)
            Logical Minimum (0)
            Logical Maximum (2147483647)
            Report Size (32)
            Report Count (5)
            Feature (Const,Var,Abs)
            End Collection
        Report ID (0x02)
        Usage (LampAttributesRequestReport)
        Collection (Logical)
            Header
            Collection type: Logical (0x02)
            Usage (LampId)
            Logical Minimum (0)
            Logical Maximum (65535)
            Report Size (16)
            Report Count (1)
            Feature (Data,Var,Abs)
            End Collection
        Report ID (0x03)
        Usage (LampAttributesResponseReport)
        Collection (Logical)
            Header
            Collection type: Logical (0x02)
            Usage (LampId)
            Logical Minimum (0)
            Logical Maximum (65535)
            Report Size (16)
            Report Count (1)
            Feature (Data,Var,Abs)
            Usage (PositionXInMicrometers)
            Usage (PositionYInMicrometers)
            Usage (PositionZInMicrometers)
            Usage (UpdateLatencyInMicroseconds)
            Usage (LampPurposes)
            Logical Minimum (0)
            Logical Maximum (2147483647)
            Report Size (32)
            Report Count (5)
            Feature (Data,Var,Abs)
            Usage (RedLevelCount)
            Usage (GreenLevelCount)
            Usage (BlueLevelCount)
            Usage (IsProgrammable)
            Usage (InputBinding)
            Logical Minimum (0)
            Logical Maximum (255)
            Report Size (8)
            Report Count (5)
            Feature (Data,Var,Abs)
            End Collection
        Report ID (0x04)
        Usage (LampMultiUpdateReport)
        Collection (Logical)
            Header
            Collection type: Logical (0x02)
            Usage (LampCount)
            Usage (LampUpdateFlags)
            Logical Minimum (0)
            Logical Maximum (8)
            Report Size (8)
            Report Count (2)
            Feature (Data,Var,Abs)
            Usage (LampId)
            Logical Minimum (0)
            Logical Maximum (65535)
            Report Size (16)
            Report Count (8)
            Feature (Data,Var,Abs)
            Usage (RedUpdateChannel)
            Usage (GreenUpdateChannel)
            Usage (BlueUpdateChannel)
            Usage (RedUpdateChannel)
            Usage (GreenUpdateChannel)
            Usage (BlueUpdateChannel)
            Usage (RedUpdateChannel)
            Usage (GreenUpdateChannel)
            Usage (BlueUpdateChannel)
            Usage (RedUpdateChannel)
            Usage (GreenUpdateChannel)
            Usage (BlueUpdateChannel)
            Usage (RedUpdateChannel)
            Usage (GreenUpdateChannel)
            Usage (BlueUpdateChannel)
            Usage (RedUpdateChannel)
            Usage (GreenUpdateChannel)
            Usage (BlueUpdateChannel)
            Usage (RedUpdateChannel)
            Usage (GreenUpdateChannel)
            Usage (BlueUpdateChannel)
            Usage (RedUpdateChannel)
            Usage (GreenUpdateChannel)
            Usage (BlueUpdateChannel)
            Logical Minimum (0)
            Logical Maximum (255)
            Report Size (8)
            Report Count (24)
            Feature (Data,Var,Abs)
            End Collection
        Report ID (0x05)
        Usage (LampRangeUpdateReport)
        Collection (Logical)
            Header
            Collection type: Logical (0x02)
            Usage (LampUpdateFlags)
            Logical Minimum (0)
            Logical Maximum (8)
            Report Size (8)
            Report Count (1)
            Feature (Data,Var,Abs)
            Usage (LampIdStart)
            Usage (LampIdEnd)
            Logical Minimum (0)
            Logical Maximum (65535)
            Report Size (16)
            Report Count (2)
            Feature (Data,Var,Abs)
            Usage (RedUpdateChannel)
            Usage (GreenUpdateChannel)
            Usage (BlueUpdateChannel)
            Logical Minimum (0)
            Logical Maximum (255)
            Report Size (8)
            Report Count (3)
            Feature (Data,Var,Abs)
            End Collection
        Report ID (0x06)
        Usage (LampArrayControlReport)
        Collection (Logical)
            Header
            Collection type: Logical (0x02)
            Usage (AutonomousMode)
            Logical Minimum (0)
            Logical Maximum (1)
            Report Size (8)
            Report Count (1)
            Feature (Data,Var,Abs)
            End Collection
        Report ID (0x07)
        Usage Page (Vendor)
        Logical Minimum (0)
        Logical Maximum (255)
        Usage (Vendor)
        Report Size (8)
        Report Count (63)
        Feature (Data,Var,Abs)
        End Collection
    Usage Page (Consumer)
    Usage (Consumer Control)
    Collection (Application)
        Header
        Collection type: Application (0x01)
        Report ID (0x08)
        Usage Minimum (0xd0)
        Usage Maximum (0xd7)
        Logical Minimum (0)
        Logical Maximum (1)
        Report Size (1)
        Report Count (8)
        Input (Data,Var,Abs)
        End Collection

Interface 4:

HID Report
    Usage Page (Lighting and Illumination)
    Usage (LampArray)
    Collection (Application)
        Header
        Collection type: Application (0x01)
        Report ID (0x01)
        Usage (LampArrayAttributesReport)
        Collection (Logical)
            Header
            Collection type: Logical (0x02)
            Usage (LampCount)
            Logical Minimum (0)
            Logical Maximum (65535)
            Report Size (16)
            Report Count (1)
            Feature (Const,Var,Abs)
            Usage (BoundingBoxWidthInMicrometers)
            Usage (BoundingBoxHeightInMicrometers)
            Usage (BoundingBoxDepthInMicrometers)
            Usage (LampArrayKind)
            Usage (MinUpdateIntervalInMicroseconds)
            Logical Minimum (0)
            Logical Maximum (2147483647)
            Report Size (32)
            Report Count (5)
            Feature (Const,Var,Abs)
            End Collection
        Report ID (0x02)
        Usage (LampAttributesRequestReport)
        Collection (Logical)
            Header
            Collection type: Logical (0x02)
            Usage (LampId)
            Logical Minimum (0)
            Logical Maximum (65535)
            Report Size (16)
            Report Count (1)
            Feature (Data,Var,Abs)
            End Collection
        Report ID (0x03)
        Usage (LampAttributesResponseReport)
        Collection (Logical)
            Header
            Collection type: Logical (0x02)
            Usage (LampId)
            Logical Minimum (0)
            Logical Maximum (65535)
            Report Size (16)
            Report Count (1)
            Feature (Data,Var,Abs)
            Usage (PositionXInMicrometers)
            Usage (PositionYInMicrometers)
            Usage (PositionZInMicrometers)
            Usage (UpdateLatencyInMicroseconds)
            Usage (LampPurposes)
            Logical Minimum (0)
            Logical Maximum (2147483647)
            Report Size (32)
            Report Count (5)
            Feature (Data,Var,Abs)
            Usage (RedLevelCount)
            Usage (GreenLevelCount)
            Usage (BlueLevelCount)
            Usage (IsProgrammable)
            Usage (InputBinding)
            Logical Minimum (0)
            Logical Maximum (255)
            Report Size (8)
            Report Count (5)
            Feature (Data,Var,Abs)
            End Collection
        Report ID (0x04)
        Usage (LampMultiUpdateReport)
        Collection (Logical)
            Header
            Collection type: Logical (0x02)
            Usage (LampCount)
            Usage (LampUpdateFlags)
            Logical Minimum (0)
            Logical Maximum (8)
            Report Size (8)
            Report Count (2)
            Feature (Data,Var,Abs)
            Usage (LampId)
            Logical Minimum (0)
            Logical Maximum (65535)
            Report Size (16)
            Report Count (8)
            Feature (Data,Var,Abs)
            Usage (RedUpdateChannel)
            Usage (GreenUpdateChannel)
            Usage (BlueUpdateChannel)
            Usage (RedUpdateChannel)
            Usage (GreenUpdateChannel)
            Usage (BlueUpdateChannel)
            Usage (RedUpdateChannel)
            Usage (GreenUpdateChannel)
            Usage (BlueUpdateChannel)
            Usage (RedUpdateChannel)
            Usage (GreenUpdateChannel)
            Usage (BlueUpdateChannel)
            Usage (RedUpdateChannel)
            Usage (GreenUpdateChannel)
            Usage (BlueUpdateChannel)
            Usage (RedUpdateChannel)
            Usage (GreenUpdateChannel)
            Usage (BlueUpdateChannel)
            Usage (RedUpdateChannel)
            Usage (GreenUpdateChannel)
            Usage (BlueUpdateChannel)
            Usage (RedUpdateChannel)
            Usage (GreenUpdateChannel)
            Usage (BlueUpdateChannel)
            Logical Minimum (0)
            Logical Maximum (255)
            Report Size (8)
            Report Count (24)
            Feature (Data,Var,Abs)
            End Collection
        Report ID (0x05)
        Usage (LampRangeUpdateReport)
        Collection (Logical)
            Header
            Collection type: Logical (0x02)
            Usage (LampUpdateFlags)
            Logical Minimum (0)
            Logical Maximum (8)
            Report Size (8)
            Report Count (1)
            Feature (Data,Var,Abs)
            Usage (LampIdStart)
            Usage (LampIdEnd)
            Logical Minimum (0)
            Logical Maximum (65535)
            Report Size (16)
            Report Count (2)
            Feature (Data,Var,Abs)
            Usage (RedUpdateChannel)
            Usage (GreenUpdateChannel)
            Usage (BlueUpdateChannel)
            Logical Minimum (0)
            Logical Maximum (255)
            Report Size (8)
            Report Count (3)
            Feature (Data,Var,Abs)
            End Collection
        Report ID (0x06)
        Usage (LampArrayControlReport)
        Collection (Logical)
            Header
            Collection type: Logical (0x02)
            Usage (AutonomousMode)
            Logical Minimum (0)
            Logical Maximum (1)
            Report Size (8)
            Report Count (1)
            Feature (Data,Var,Abs)
            End Collection
        Report ID (0x07)
        Usage Page (Vendor)
        Logical Minimum (0)
        Logical Maximum (255)
        Usage (Vendor)
        Report Size (8)
        Report Count (63)
        Feature (Data,Var,Abs)
        End Collection

# Calling the device through razer drivers

Provided we install the drivers on our computer without synapse, is should be possible to access the Razer protocol features without actually relying on Synapse software.
Regarding this, the question of how to get our hands on the drivers remain.
Installing Synapse 3 to get the drivers for the device installed on the disk is a solution that works, but not one that is flexible.
Synapse 3 will only (download ?) & install drivers for the devices that are required, which is a wise choice. (It is a feature I thought about for a much later version Exo, so I can't blame them :))
It will have to do for now, though. (I'm assuming it would be possible to manually download those from their servers, but I'm unsure this is acceptable)

From what I can see, the drivers do, as I suspected, provide a way to bypass the standard Windows HID stack and emit or receive HID reports that Windows would deem invalid.

Thankfully, they do this in a quite simple way, by exposing a custom Get/Set Feature Report as IO Control Codes.

For the Dock, I got the following IO Control codes:

SetFeature: 0x88883010
GetFeature: 0x88883014

The calls are as straightforward as they get. No shenanigans here.
I'm assuming these are 100% compatible with the standard Widows HidD_SetFeature / HidD_GetFeature, meaning that they would include the Report ID byte. If not, it will be easy to detect.

I still don't know if these IO control codes are universal, and on which device interface they should be used.
It is possible they work on all device interfaces, but I doubt their software would open one at random.

I'm assuming the SetFeature/GetFeature stuff is quite universal across drivers for this generation of hardware, as I have a hard time imagining Razer writing 100% custom drivers for each and every device.
It is however possible that their build system would generate drivers for each device with slightly different parameters and use different IoControl codes just for the sake of doing it.
(That's actually what I would do if I wanted to make my stuff hard to interoperate with, as they seemingly did here by hiding their features from Windows user mode)

As for the device to open, it would seem that the drivers create device notes under the following custom device class GUID: e3be005d-d130-4910-88ff-09ae02f680e9
Those devices would generally have a name like those:

 \\?\RZCONTROL#VID_1532&PID_007D&MI_00#a&1ddbaa2e&0#{e3be005d-d130-4910-88ff-09ae02f680e9}
 \\?\RZCONTROL#VID_1532&PID_007E&MI_00#a&33f42eb&0#{e3be005d-d130-4910-88ff-09ae02f680e9}

Aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaannnnd… It works !

Just sending that one command to the dock device is enough to change its color:

00001f000000080f030000000000ea1134000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000cb00

And just to be sure, the same command manually adjusted for generating to green (00FF00) works:

00001f000000080f03000000000000ff00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000fb00

It does seem to immediately switch the dock to "static color" at the same time, so there is definitely something more to do here, but having this working is definitely great news.
Having to deal with the razer custom drivers is certainly less than ideal, but at least it is easy to work with in that case.
