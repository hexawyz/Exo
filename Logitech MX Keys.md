# The device

Vendor ID: 046D (Logitech)
Product ID: B361/B36A

# Analysis

The device seem more complex than a traditional keyboard, as it can be accessed directly over bluetooth, or indirectly over a logitech USB dongle. (Unifying or Bolt)
It exposes 4 different HID collections, and the 4th one (Report ID 17(0x11) / Usage page FF43 / Usage 00CA) seems to be used to expose advanced features.
Upon startup, the Logitech Options Software will configure the keyboard in different ways and change the behavior of some keys. It leads the keyboard to emit quite a few informations that need yet to
be decoded.
It seems the custom protocol is more or less openly documented as HID++ 2.0: https://lekensteyn.nl/files/logitech/logitech_hidpp_2.0_specification_draft_2012-06-04.pdf
We can find information on some feature names here: https://github.com/Logitech/cpg-docs/blob/master/hidpp20/README.rst & https://pwr-solaar.github.io/Solaar/features.html
And libratbag could be of some help to understand some details: https://github.com/libratbag/libratbag

## Supported HID++ features

Features manually listed from the device, and name from external sources when available:

01:0001 IFeatureSet
02:0003 Device Information
03:0005 Device Name and Type
04:1D4B Wireless Device Status
05:0020 Config Change
06:0007 Device Friendly Name
07:1004 UNIFIED_BATTERY
08:1B04 Keyboard reprogrammable Keys and Mouse buttons 5
09:1814 Change Host
0A:1815 HOSTS_INFO
0B:1982 Backlight 2
0C:40A3 Fn Inversion, for multi-host devices
0D:4220 Lock Key State
0E:4521 Disable Keys
0F:4531 MULTIPLATFORM
10:00C3
11:1802 DEVICE_RESET
12:1803
13:1806 CONFIG_DEVICE_PROPS
14:1816
15:1805 OOBSTATE
16:1830
17:1891
18:18A1
19:1E00
1A:1E02
1B:1602
1C:1EB0
1D:1861
1E:1A20
1F:18B0

## HID APIs

When Logitech options is not started, the keyboard is able to properly switch computers on its own, as well as perform backlighting adjustments as usual, and handle basic multimedia key features.
e.g.: Paly/Payse, Mute, Volume Up, Volume Down.
Some more advanced features such as toggling emoji input, lauching the screenshot tool, or muting the mic, are not supported out of the box. (They may not be any HID standard way of producing these)

We can get feedback for some features of the keyboard by listening to the custom HID colelction used by logitech. Basic messages seem to be straightforward, but we'd be more interested in the more
advanced ones. i.e. Allowing configuration of the keyboard, how the feedback from the configuration is returned, and how custom keystrokes are transferred.

### Analysis of an HID report

Byte 0: 11 is the report ID (17)
Byte 1: FF seems to always be there for some reason (constant value ?)
Byte 2: Seems to be a command or category ID (Key presses: 08, FN lock: 0C, Caps lock: 0D, Linked computers stuff: 0A; Backlighting stuff: 0B; ???: 07)
Byte 3: May be a subcommand ID in some cases at least

### FF0D - Lock status

11FF0D0003000000000000000000000000000000
11FF0D0001000000000000000000000000000000
        ^^
        AA

A: Lock flags (2 = caps lock; 1 = num lock ?; 4 = scroll lock ?)

### FF0C - FN lock

We get something like this:
11FF0C0000010101000000000000000000000000
           ^ ^ ^
           A B C

A is the status of fn lock on the computer
1 = Media keys
0 = Fn keys

fn lock (media keys) is on per default

B and C could be the status for other computers, but this doesn't seem to match up with my settings.

### FF0B - Backlighting

11FF0B0008010400000000000000000000000000
        ^^^^^^
        AABBCC

B is the backlighting level
No idea what A and C are.

The 00 prefix is probably the identifier for that update.

Backlighting keypresses are not reported (here) by default. Only the current (new) backlighting setting is, once the key has been pressed.

11FF0B1B00000000000000000000000000000000
      ^^
      AA

No idea what A could be, but this is what is received after a command to change the backlighting settings is sent from the UI.

### FF08 - Key press

#### FF0800 - Basic keypresses (Like the ones out of the box)

11 FF08 0000340000000000000000000000000000
            ^^
            AA

A: FN key

11 FF08 0000000000000000000000000000000000
            ^^
            AA

A: No key down

#### FF0820 - Extended keypresses

11 FF08 20 00340100000000000000000000000000
11 FF08 20 00340000000000000000000000000000
             ^^^^
             AABB

A: FN key
B: 1 = Is down; 0 = Is Up

11 FF08 20 00E20100000000000000000000000000
11 FF08 20 00E20000000000000000000000000000
             ^^^^
             AABB

A: Backlight down
B: 1 = Is down; 0 = Is Up

11 FF08 20 01080100000000000000000000000000
11 FF08 20 01080000000000000000000000000000
           ^^^^^^
           AABBCC

A: Extended function ? (Not mapped in HID ?)
B: 03 = Voice typing; 08 = Emoji; 0A = Screenshot tool; 1C = Mute mic
C: 1 = Is down; 0 = Is Up

### FF0A - Linked computers

#### FF0A3B - Computer Name

11 FF0A 3B 01 00 XXXXXXXXXXXXXXXXXXXXXXXXXXXX
11 FF0A 3B 01 0E XX00000000000000000000000000
        ^^ ^^ ^^ ^^
        AA BB CC DD

A: Computer Name Command
B: Computer ID (00 - 01 - 02; Up to 3 computers can be linked)
C: Offset in name
D: Name in UTF-8 (continued if C > 0)

### FF02 - ???

#### FF020B - ??? Info

11 FF02 0B 0348052C670002B36A00000000000100
             ^^^^^^^^
             AAAAAAAA

A: This value is found as a property of the bluetooth device: {995ef0b0-7eb3-4a8b-b9ce-068bb3f4af69}[10] (Something related to Bluetooth LE but what ?)

#### FF021B - Version Info

11 FF02 1B 01424C315400000400B36A5518BD9100

11 FF02 1B 0052424B7400000401B36A5518BD9100
                   ^^^^^^^^
                   VVVVVVVV

V: Version number 074.000.00004 ?

## FF03 - ???

11 FF03 1B 4D58204B657973204D696E6920666F72 # "MX Keys Mini for"
11 FF03 1B 204D6163000000000000000000000000 # " Mac"

## HID dumps without Logitech Options (Software killed, keyboard restarted)

FN key DOWN:
11FF080000340000000000000000000000000000

FN key UP:
11FF080000000000000000000000000000000000

FN lock ON:
11FF0C0000010101000000000000000000000000

FN lock OFF:
11FF0C0000000101000000000000000000000000

Caps lock ON: (Assuming the byte to be a combination of the usual statuses)
11FF0D0003000000000000000000000000000000

Caps lock OFF:
11FF0D0001000000000000000000000000000000

Backlighting UP: (8 levels)
11FF0B0008010400000000000000000000000000
11FF0B0008020400000000000000000000000000
11FF0B0008030400000000000000000000000000
11FF0B0008040400000000000000000000000000
11FF0B0008050400000000000000000000000000
11FF0B0008060400000000000000000000000000
11FF0B0008070400000000000000000000000000
11FF0B0008070400000000000000000000000000

Backlighting DOWN:
11FF0B0008060400000000000000000000000000
11FF0B0008050400000000000000000000000000
11FF0B0008040400000000000000000000000000
11FF0B0008030400000000000000000000000000
11FF0B0008020400000000000000000000000000
11FF0B0008010400000000000000000000000000
11FF0B0008000400000000000000000000000000

FN+U to swap @/# and <>: No feedback apart from FN key UP/DOWN

## Starting logitech G Hub (By mistake, but it apprently does something)

11FF001B04050000000000000000000000000000
11FF001B04053900000000000000000000000000
11FF000B02000400000000000000000000000000
11FF020B0348052C670002B36A00000000000100
11FF021B01424C315400000400B36A5518BD9100
11FF021B0052424B7400000401B36A5518BD9100
11FF001B0405F300000000000000000000000000
11FF000B03000000000000000000000000000000
11FF032B00000000000000000000000000000000
11FF001B04056E00000000000000000000000000
11FF000B01000200000000000000000000000000
11FF010B1F000000000000000000000000000000 # IFeatureSet.Count() = 31 features ?
11FF001B04057400000000000000000000000000
11FF000B00000000000000000000000000000000
11FF030B14000000000000000000000000000000
11FF031B4D58204B657973204D696E6920666F72 # "MX Keys Mini for"
11FF031B204D6163000000000000000000000000 # " Mac"
11FF001B0405E100000000000000000000000000
11FF000B00000000000000000000000000000000
11FF001B04058C00000000000000000000000000
11FF000B00000000000000000000000000000000

## Starting logitech options

11FF070064080301000000000000000000000000 # First command sent on initialization

11FF001B04053900000000000000000000000000 # Get protocol version => 4.5
11FF020B0348052C670002B36A00000000000100
11FF021B0052424B7400000401B36A5518BD9100
11FF090B03000000000000000000000000000000
11FF070B0F030000000000000000000000000000
11FF071B64080301000000000000000000000000
11FF082B00D10000000000000000000000000000
11FF050B00000000000000000000000000000000
11FF051B48250000000000000000000000000000
11FF083B00D10000000300000000000000000000
11FF082B00D20000000000000000000000000000
11FF083B00D20000000300000000000000000000
11FF082B00D30000000000000000000000000000
11FF083B00D30000000300000000000000000000
11FF083B00E20200000B00000000000000000000
11FF083B00E30200000B00000000000000000000
11FF083B01030300000B00000000000000000000
11FF083B01080300000B00000000000000000000
11FF083B010A0300000B00000000000000000000
11FF083B011C0300000B00000000000000000000
11FF083B00E50300000B00000000000000000000
11FF083B00E70300000B00000000000000000000
11FF083B00E80300000B00000000000000000000
11FF083B00E90300000B00000000000000000000
11FF083B011D0300000B00000000000000000000
11FF082B00DE0000000000000000000000000000
11FF083B00DE0000000300000000000000000000
11FF082B00340000000000000000000000000000
11FF083B00340000000300000000000000000000
11FF090B03000000000000000000000000000000
11FF092B0A000500000000000000000000000000
11FF0A0B13040300000000000000000000000000
11FF0A8B00000000000000000000000000000000
11FF0B0B01050500000000000000000000000000
11FF090B03000000000000000000000000000000
11FF0E2B00000000000000000000000000000000
11FF0F0B03000202030000000000000000000000
11FF0F1B00002000000000000000000000000000
11FF0F1B01014000000000000000000000000000
11FF0F2B00010000FFFF00000000000000000000
11FF0F2B01010000FFFF00000000000000000000
11FF0F2B02010000FFFF00000000000000000000
11FF071B64080301000000000000000000000000
11FF070B0F030000000000000000000000000000
11FF0F0B03000202030000000000000000000000
11FF0F1B00002000000000000000000000000000
11FF0F1B01014000000000000000000000000000
11FF0F2B00010000FFFF00000000000000000000
11FF0F2B01010000FFFF00000000000000000000
11FF0F2B02010000FFFF00000000000000000000
11FF0A0B13040300000000000000000000000000
11FF0A1B00010402091800000000000000000000
11FF0A7B00010B00000000000000000000000000
11FF0A1B00010402091800000000000000000000
11FF0A3B0000XXXXXXXXXXXXXXXXXX0000000000 # UTF-8 Computer name
11FF0A4B00030000000000000000000000000000
11FF0A1B010104020F1800000000000000000000
11FF0A7B01000000000000000000000000000000
11FF0A1B010104020F1800000000000000000000
11FF0A3B0100XXXXXXXXXXXXXXXXXXXXXXXXXXXX # ASCII Computer name
11FF0A3B010EXX00000000000000000000000000 # ASCII Computer name (continued)
11FF0A1B02010402081800000000000000000000
11FF0A7B02010A00000000000000000000000000
11FF0A1B02010402081800000000000000000000
11FF0A3B0200XXXXXXXXXXXXXXXX000000000000 # ASCII Computer name
11FF090B03000000000000000000000000000000
11FF071B64080301000000000000000000000000
11FF070B0F030000000000000000000000000000
11FF0F0B03000202030000000000000000000000
11FF0F1B00002000000000000000000000000000
11FF0F1B01014000000000000000000000000000
11FF0F2B00010000FFFF00000000000000000000
11FF0F2B01010000FFFF00000000000000000000
11FF0F2B02010000FFFF00000000000000000000
11FF0A0B13040300000000000000000000000000
11FF0A1B00010402031800000000000000000000
11FF0A7B00010B00000000000000000000000000
11FF0A1B00010402031800000000000000000000
11FF0A3B0000A2A4B90000000000000000000000 # Should be computer name but ???
11FF0A1B010104020F1800000000000000000000
11FF0A7B01000000000000000000000000000000
11FF0A1B010104020F1800000000000000000000
11FF0A3B0100XXXXXXXXXXXXXXXXXXXXXXXXXXXX # ASCII Computer name
11FF0A3B010EXX00000000000000000000000000 # ASCII Computer name (continued)
11FF0A1B02010402081800000000000000000000
11FF0A7B02010A00000000000000000000000000
11FF0A1B02010402081800000000000000000000
11FF0A3B0200XXXXXXXXXXXXXXXX000000000000 # ASCII Computer name
11FF090B03000000000000000000000000000000
11FF092B0A000500000000000000000000000000

## Clicking on the keyboard in logitech options

11FF090B03000000000000000000000000000000
11FF0C0B00000101000000000000000000000000
11FF0B0B01050500000000000000000000000000
11FF0F0B03000202030000000000000000000000
11FF0F1B00002000000000000000000000000000
11FF0F1B01014000000000000000000000000000
11FF0F2B00010000FFFF00000000000000000000
11FF0F2B01010000FFFF00000000000000000000
11FF0F2B02010000FFFF00000000000000000000
11FF0A0B13040300000000000000000000000000
11FF0A1B00010402031800000000000000000000
11FF0A7B00010B00000000000000000000000000
11FF0A1B00010402031800000000000000000000
11FF0A3B0000A2A4B90000000000000000000000
11FF0A1B010104020F1800000000000000000000
11FF0A7B01000000000000000000000000000000
11FF0A1B010104020F1800000000000000000000
11FF0A3B0100XXXXXXXXXXXXXXXXXXXXXXXXXXXX # ASCII Computer name
11FF0A3B010EXX00000000000000000000000000 # ASCII Computer name (continued)
11FF0A1B02010402081800000000000000000000
11FF0A7B02010A00000000000000000000000000
11FF0A1B02010402081800000000000000000000
11FF0A3B0200XXXXXXXXXXXXXXXX000000000000 # ASCII Computer name
11FF090B03000000000000000000000000000000
11FF0C1B00000101000000000000000000000000

FN lock ON in the UI:

11FF090B03000000000000000000000000000000
11FF0C1B00010101000000000000000000000000

FN lock OFF in the UI:

11FF090B03000000000000000000000000000000
11FF0C1B00000101000000000000000000000000

Feedback from backlighting commands in the UI (enable/disable & energy saving):

11FF0B1B00000000000000000000000000000000

## HID dumps once Logitech Options is active

FN key DOWN:
11FF080000340000000000000000000000000000 # Same as without
11FF082000340100000000000000000000000000

FN key UP:
11FF080000000000000000000000000000000000 # Same as without
11FF082000340000000000000000000000000000

Backlight down:
11FF080000340000000000000000000000000000 # FN Key DOWN (standard message)
11FF082000340100000000000000000000000000 # FN key DOWN (new message)
11FF082000E20100000000000000000000000000 # Backlight down DOWN (new message)
11FF0B0008060400000000000000000000000000 # Status update
11FF0B0008050400000000000000000000000000 # Status update
11FF0B0008040400000000000000000000000000 # Status update
11FF0B0008030400000000000000000000000000 # Status update
11FF0B0008020400000000000000000000000000 # Status update
11FF0B0008010400000000000000000000000000 # Status update
11FF0B0008000400000000000000000000000000 # Status update
11FF082000E20000000000000000000000000000 # Backlight down UP (new message)
11FF080000000000000000000000000000000000 # FN Key UP (standard message)
11FF082000340000000000000000000000000000 # FN key UP (new message)

Backlight up:
11FF080000340000000000000000000000000000 # FN Key DOWN (standard message)
11FF082000340100000000000000000000000000 # FN key DOWN (new message)
11FF082000E30100000000000000000000000000 # Backlight up DOWN (new message)
11FF0B0008010400000000000000000000000000 # Status update
11FF0B0008020400000000000000000000000000 # Status update
11FF0B0008030400000000000000000000000000 # Status update
11FF0B0008040400000000000000000000000000 # Status update
11FF0B0008050400000000000000000000000000 # Status update
11FF0B0008060400000000000000000000000000 # Status update
11FF0B0008070400000000000000000000000000 # Status update
11FF082000E30000000000000000000000000000 # Backlight up UP (new message)
11FF080000000000000000000000000000000000 # FN Key UP (standard message)
11FF082000340000000000000000000000000000 # FN key UP (new message)

Voice typing key :
11FF080000340000000000000000000000000000 # FN Key DOWN (standard message)
11FF082000340100000000000000000000000000 # FN key DOWN (new message)
11FF080000340103000000000000000000000000 # FN key DOWN + Voice typing DOWN ?
11FF082001030100000000000000000000000000 # Voice typing DOWN ? (new message)
11FF080000340000000000000000000000000000 # FN key DOWN (Probably canceling the Voice typing command above)
11FF082001030000000000000000000000000000 # Voice typing UP ? (new message)
11FF080000000000000000000000000000000000 # FN Key UP (standard message)
11FF082000340000000000000000000000000000 # FN key UP (new message)

Emoji pad:
11FF080000340000000000000000000000000000 # FN Key DOWN (standard message)
11FF082000340100000000000000000000000000 # FN key DOWN (new message)
11FF080000340108000000000000000000000000 # FN key DOWN + Emoji DOWN ?
11FF082001080100000000000000000000000000 # Emoji DOWN ? (new message)
11FF080000340000000000000000000000000000 # FN key DOWN (Probably canceling the Emoji command above)
11FF082001080000000000000000000000000000 # Emoji UP ? (new message)
11FF080000000000000000000000000000000000 # FN Key UP (standard message)
11FF082000340000000000000000000000000000 # FN key UP (new message)

Screenshot tool:
11FF080000340000000000000000000000000000
11FF082000340100000000000000000000000000
11FF08000034010A000000000000000000000000 # FN + Screenshot tool DOWN
11FF0820010A0100000000000000000000000000 # Screenshot tool DOWN
11FF080000340000000000000000000000000000 # FN key DOWN (Screenshot tool UP)
11FF0820010A0000000000000000000000000000 # Screenshot tool UP
11FF080000000000000000000000000000000000
11FF082000340000000000000000000000000000

Mute mic:
11FF080000340000000000000000000000000000
11FF082000340100000000000000000000000000
11FF08000034011C000000000000000000000000
11FF0820011C0100000000000000000000000000
11FF080000340000000000000000000000000000
11FF0820011C0000000000000000000000000000
11FF080000000000000000000000000000000000
11FF082000340000000000000000000000000000

Play/Pause:
11FF080000340000000000000000000000000000
11FF082000340100000000000000000000000000
11FF0800003400E5000000000000000000000000
11FF082000E50100000000000000000000000000
11FF080000340000000000000000000000000000
11FF082000E50000000000000000000000000000
11FF080000000000000000000000000000000000
11FF082000340000000000000000000000000000

Mute:
11FF080000340000000000000000000000000000
11FF082000340100000000000000000000000000
11FF0800003400E7000000000000000000000000
11FF082000E70100000000000000000000000000
11FF080000340000000000000000000000000000
11FF082000E70000000000000000000000000000
11FF080000000000000000000000000000000000
11FF082000340000000000000000000000000000

Volume down:
11FF080000340000000000000000000000000000
11FF082000340100000000000000000000000000
11FF0800003400E8000000000000000000000000
11FF082000E80100000000000000000000000000
11FF080000340000000000000000000000000000
11FF082000E80000000000000000000000000000
11FF080000000000000000000000000000000000
11FF082000340000000000000000000000000000

Volume up with fn key:
11FF080000340000000000000000000000000000
11FF082000340100000000000000000000000000
11FF0800003400E9000000000000000000000000
11FF082000E90100000000000000000000000000
11FF080000340000000000000000000000000000
11FF082000E90000000000000000000000000000
11FF080000000000000000000000000000000000
11FF082000340000000000000000000000000000

Volume up without fn key:
11FF080000E90000000000000000000000000000
11FF082000E90100000000000000000000000000
11FF080000000000000000000000000000000000
11FF082000E90000000000000000000000000000

Lock session:
11FF0800011D0000000000000000000000000000
11FF0820011D0100000000000000000000000000
11FF080000000000000000000000000000000000
11FF0820011D0000000000000000000000000000
