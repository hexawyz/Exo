<Project Sdk="Microsoft.NET.Sdk.Web">

  <PropertyGroup>
    <TargetFramework>net8.0-windows</TargetFramework>
		<ImplicitUsings>enable</ImplicitUsings>
		<AllowUnsafeBlocks>true</AllowUnsafeBlocks>
		<ServerGarbageCollection>false</ServerGarbageCollection>
		<EnableFakeDevices>false</EnableFakeDevices>
		<EnableFakeDevices Condition="'$(Configuration)' == 'Debug'">true</EnableFakeDevices>
		<DefineConstants Condition="'$(EnableFakeDevices)' == 'true'">$(DefineConstants);WITH_FAKE_DEVICES</DefineConstants>
		<ApplicationManifest>app.manifest</ApplicationManifest>
  </PropertyGroup>
	
	<ItemGroup>
		<PackageReference Include="protobuf-net.Grpc.AspNetCore" Version="1.1.1" />
    <PackageReference Include="Serilog.AspNetCore" Version="6.1.0" />
	</ItemGroup>

	<!-- These references are not used in the service itself but can be necessary for drivers. -->
	<ItemGroup>
		<PackageReference Include="Microsoft.Management.Infrastructure" />
		<PackageReference Include="System.Reactive" />
	</ItemGroup>

	<!--
	Always reference all the device tools projects, because these are the base of everything.
	This does mean that yeah, we are explicitly bringing in support for Logitech HID++ here even if the driver were not to exist.
	We can revisit this later if needed, but for now this is way simpler.
	-->
	<ItemGroup>
		<ProjectReference Include="..\DeviceTools.Core\DeviceTools.Core.csproj" />
		<ProjectReference Include="..\DeviceTools.Firmware\DeviceTools.Firmware.csproj" />
		<ProjectReference Include="..\DeviceTools.DisplayDevices\DeviceTools.DisplayDevices.csproj" />
		<ProjectReference Include="..\DeviceTools.HumanInterfaceDevices\DeviceTools.HumanInterfaceDevices.csproj" />
		<ProjectReference Include="..\DeviceTools.Logitech.HidPlusPlus\DeviceTools.Logitech.HidPlusPlus.csproj" />
		<ProjectReference Include="..\Exo.Discovery.Root\Exo.Discovery.Root.csproj" />
		<ProjectReference Include="..\Exo.Extensions.Hosting.WindowsServices\Exo.Extensions.Hosting.WindowsServices.csproj" />
    <ProjectReference Include="..\Exo.Overlay.Contracts\Exo.Overlay.Contracts.csproj" />
    <ProjectReference Include="..\Exo.Service.Core\Exo.Service.Core.csproj" />
    <ProjectReference Include="..\Exo.Service.ImageService\Exo.Service.ImageService.csproj" />
		<ProjectReference Include="..\Exo.Ui.Contracts\Exo.Ui.Contracts.csproj" />
		<ProjectReference Condition="'$(EnableFakeDevices)' == 'true'" Include="..\Exo.Debug\Exo.Debug.csproj" />
  </ItemGroup>

	<!-- Detect plugin project names. -->
	<ItemGroup>
		<PluginProjectDirectory Include="$([System.IO.Directory]::GetDirectories('$(MSBuildThisFileDirectory)..', 'Exo.Devices.*'))" />
		<PluginProjectDirectory Include="$([System.IO.Directory]::GetDirectories('$(MSBuildThisFileDirectory)..', 'Exo.Discovery.*'))" Exclude="..\Exo.Discovery.Root" />
		<PluginProject Include="@(PluginProjectDirectory-&gt;'%(Filename)%(Extension)'-&gt;ClearMetadata())" />
		<PluginProjectReference Include="@(PluginProject-&gt;'..\%(Identity)\%(Identity).csproj'-&gt;ClearMetadata())" />
	</ItemGroup>

	<!-- Automatically reference plugin projects. -->
	<!-- TODO: Copy build files in a plugin directory later on. -->
	<ItemGroup Condition="'$(BuildingInsideVisualStudio)' != 'true'">
		<ProjectReference Include="@(PluginProjectReference-&gt;ClearMetadata())" Private="false" ReferenceOutputAssembly="false" />
	</ItemGroup>
	<!-- When running in visual studio, manually reference some plugin projects, because Visual Studio would ignore the automatic stuff above. -->
	<ItemGroup Condition="'$(BuildingInsideVisualStudio)' == 'true'">
		<ProjectReference Include="..\Exo.Devices.Apple.Keyboard\Exo.Devices.Apple.Keyboard.csproj" Private="false" ReferenceOutputAssembly="false" />
		<ProjectReference Include="..\Exo.Devices.Logitech\Exo.Devices.Logitech.csproj" Private="false" ReferenceOutputAssembly="false" />
		<ProjectReference Include="..\Exo.Devices.Gigabyte\Exo.Devices.Gigabyte.csproj" Private="false" ReferenceOutputAssembly="false" />
		<ProjectReference Include="..\Exo.Devices.Monitors\Exo.Devices.Monitors.csproj" Private="false" ReferenceOutputAssembly="false" />
		<ProjectReference Include="..\Exo.Devices.Lg.Monitors\Exo.Devices.Lg.Monitors.csproj" Private="false" ReferenceOutputAssembly="false" />
		<ProjectReference Include="..\Exo.Devices.Razer\Exo.Devices.Razer.csproj" Private="false" ReferenceOutputAssembly="false" />
		<ProjectReference Include="..\Exo.Devices.Elgato.StreamDeck\Exo.Devices.Elgato.StreamDeck.csproj" Private="false" ReferenceOutputAssembly="false" />
		<ProjectReference Include="..\Exo.Devices.Intel\Exo.Devices.Intel.csproj" Private="false" ReferenceOutputAssembly="false" />
		<ProjectReference Include="..\Exo.Devices.NVidia\Exo.Devices.NVidia.csproj" Private="false" ReferenceOutputAssembly="false" />
		<ProjectReference Include="..\Exo.Devices.Asus.Aura\Exo.Devices.Asus.Aura.csproj" Private="false" ReferenceOutputAssembly="false" />
		<ProjectReference Include="..\Exo.Discovery.Hid\Exo.Discovery.Hid.csproj" Private="false" ReferenceOutputAssembly="false" />
		<ProjectReference Include="..\Exo.Discovery.System\Exo.Discovery.System.csproj" Private="false" ReferenceOutputAssembly="false" />
		<ProjectReference Include="..\Exo.Discovery.Pci\Exo.Discovery.Pci.csproj" Private="false" ReferenceOutputAssembly="false" />
		<ProjectReference Include="..\Exo.Discovery.Monitor\Exo.Discovery.Monitor.csproj" Private="false" ReferenceOutputAssembly="false" />
		<ProjectReference Include="..\Exo.Discovery.SmBios\Exo.Discovery.SmBios.csproj" Private="false" ReferenceOutputAssembly="false" />
	</ItemGroup>

	<Target Name="AddPluginFilesToPublishList" BeforeTargets="ComputeResolvedFilesToPublishList">
		<MSBuild Projects="%(PluginProjectReference.Identity)" Targets="GetTargetPath" Properties="Configuration=$(Configuration);RuntimeIdentifier=$(RuntimeIdentifier);SelfContained=$(SelfContained)">
			<Output TaskParameter="TargetOutputs" ItemName="PluginPrimaryAssembly" />
		</MSBuild>

		<ItemGroup>
			<ResolvedFileToPublish Include="@(PluginPrimaryAssembly-&gt;ClearMetadata())">
				<RelativePath>plugins\%(Filename)%(Extension)</RelativePath>
				<CopyToPublishDirectory>PreserveNewest</CopyToPublishDirectory>
			</ResolvedFileToPublish>
		</ItemGroup>
	</Target>

</Project>
